# .github/workflows/snowflake_cicd.yml
name: Deploy Snowflake View

env:
  SCHEMA_PRD: PRD

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  dev:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien

      - name: Download and install SnowSQL via RPM
        run: |
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm

      - name: Add SnowSQL to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH

      - name: Check SnowSQL installation
        run: which snowsql && snowsql -v

      - name: Run SQL (DEV) in ordered phases
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        run: |
          set -euo pipefail
          shopt -s nullglob globstar

          # ---------- Helpers ----------
          run_snowsql () {
            local schema="$1"; local file="$2"
            echo "Running ${file} on schema ${schema}"
            snowsql \
              -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -d "$SNOWSQL_DB" -s "$schema" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o variable_substitution=true \
              -o exit_on_error=true \
              -o log_level=INFO \
              -f "$file" \
              --variable "SNOWSQL_AWS_KEY_ID=$SNOWSQL_AWS_KEY_ID" \
              --variable "SNOWSQL_AWS_SECRET_KEY=$SNOWSQL_AWS_SECRET_KEY"
          }

          list_sorted () {
            # prints sorted list if files exist
            for f in "$@"; do [ -e "$f" ] && echo "$f"; done | sort
          }

          # ---------- Phase 1: migrations/database ----------
          PHASE1=$(list_sorted migrations/database/*.sql)
          for f in $PHASE1; do run_snowsql "DEV" "$f"; done

          # ---------- Phase 2: migrations/snowflake ----------
          PHASE2=$(list_sorted migrations/snowflake/*.sql)
          for f in $PHASE2; do run_snowsql "DEV" "$f"; done

          # ---------- Phase 3: Medallion ----------
          # Order inside each layer: ddl -> views -> procedures -> (others) -> tasks
          order_layer () {
            local layer="$1"
            list_sorted \
              "layers/${layer}/ddl/"*.sql \
              "layers/${layer}/views/"*.sql \
              "layers/${layer}/procedures/"*.sql \
              "layers/${layer}/"*.sql
            # tasks last
            list_sorted "layers/${layer}/tasks/"*.sql
          }

          PHASE3_BRONZE=$(order_layer bronze)
          PHASE3_SILVER=$(order_layer silver)
          PHASE3_GOLD=$(order_layer gold)

          for f in $PHASE3_BRONZE; do run_snowsql "DEV" "$f"; done
          for f in $PHASE3_SILVER; do run_snowsql "DEV" "$f"; done
          for f in $PHASE3_GOLD;   do run_snowsql "DEV" "$f"; done

  qa:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    needs: dev
    steps:
      - uses: actions/checkout@v3
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien
      - name: Download and install SnowSQL via RPM
        run: |
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm
      - name: Add SnowSQL to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH
      - name: Check SnowSQL installation
        run: which snowsql && snowsql -v
      - name: Run SQL (QA) in ordered phases
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        run: |
          set -euo pipefail
          shopt -s nullglob globstar

          run_snowsql () {
            local schema="$1"; local file="$2"
            echo "Running ${file} on schema ${schema}"
            snowsql \
              -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -d "$SNOWSQL_DB" -s "$schema" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o variable_substitution=true \
              -o exit_on_error=true \
              -o log_level=INFO \
              -f "$file" \
              --variable "SNOWSQL_AWS_KEY_ID=$SNOWSQL_AWS_KEY_ID" \
              --variable "SNOWSQL_AWS_SECRET_KEY=$SNOWSQL_AWS_SECRET_KEY"
          }

          list_sorted () { for f in "$@"; do [ -e "$f" ] && echo "$f"; done | sort; }
          order_layer () {
            local layer="$1"
            list_sorted \
              "layers/${layer}/ddl/"*.sql \
              "layers/${layer}/views/"*.sql \
              "layers/${layer}/procedures/"*.sql \
              "layers/${layer}/"*.sql
            list_sorted "layers/${layer}/tasks/"*.sql
          }

          for f in $(list_sorted migrations/database/*.sql);   do run_snowsql "QA" "$f"; done
          for f in $(list_sorted migrations/snowflake/*.sql);  do run_snowsql "QA" "$f"; done
          for f in $(order_layer bronze); do run_snowsql "QA" "$f"; done
          for f in $(order_layer silver); do run_snowsql "QA" "$f"; done
          for f in $(order_layer gold);   do run_snowsql "QA" "$f"; done

  prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien
      - name: Download and install SnowSQL via RPM
        run: |
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm
      - name: Add SnowSQL to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH
      - name: Check SnowSQL installation
        run: which snowsql && snowsql -v
      - name: Run SQL (PROD) in ordered phases
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        run: |
          set -euo pipefail
          shopt -s nullglob globstar

          run_snowsql () {
            local schema="$1"; local file="$2"
            echo "Running ${file} on schema ${schema}"
            snowsql \
              -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -d "$SNOWSQL_DB" -s "$schema" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o variable_substitution=true \
              -o exit_on_error=true \
              -o log_level=INFO \
              -f "$file" \
              --variable "SNOWSQL_AWS_KEY_ID=$SNOWSQL_AWS_KEY_ID" \
              --variable "SNOWSQL_AWS_SECRET_KEY=$SNOWSQL_AWS_SECRET_KEY"
          }

          list_sorted () { for f in "$@"; do [ -e "$f" ] && echo "$f"; done | sort; }
          order_layer () {
            local layer="$1"
            list_sorted \
              "layers/${layer}/ddl/"*.sql \
              "layers/${layer}/views/"*.sql \
              "layers/${layer}/procedures/"*.sql \
              "layers/${layer}/"*.sql
            list_sorted "layers/${layer}/tasks/"*.sql
          }

          for f in $(list_sorted migrations/database/*.sql);   do run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done
          for f in $(list_sorted migrations/snowflake/*.sql);  do run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done
          for f in $(order_layer bronze); do run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done
          for f in $(order_layer silver); do run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done
          for f in $(order_layer gold);   do run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done