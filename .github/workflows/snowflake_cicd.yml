name: Deploy Snowflake View

env:
  SCHEMA_PRD: PRD

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

# ---------- Reusable step blocks (YAML anchors) ----------
x-common-setup: &common_setup
  - uses: actions/checkout@v3

  - name: Install system dependencies
    run: |
      sudo apt-get update
      sudo apt-get install -y libaio1 libncurses6 alien

  - name: Download and install SnowSQL via RPM
    run: |
      wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
      sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm

  - name: Add SnowSQL to PATH
    run: echo "/usr/bin" >> $GITHUB_PATH

  - name: Check SnowSQL installation
    run: which snowsql && snowsql -v

x-run-changed-sql: &run_changed_sql
  - name: Run changed SQL scripts
    env:
      SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
      SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
      SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
      SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
      SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
      SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
      TARGET_SCHEMA: ${{ env.TARGET_SCHEMA }}
    run: |
      set -euo pipefail

      if git rev-parse HEAD~1 >/dev/null 2>&1; then
        MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.sql$' || true)
      else
        MODIFIED_FILES=$(git show --pretty="" --name-only HEAD | grep '\.sql$' || true)
      fi

      if [ -z "${MODIFIED_FILES:-}" ]; then
        echo "No .sql files changed."
        exit 0
      fi

      # Sort files by layer: bronze → silver → gold, tasks last
      ORDERED_FILES=$(
        echo "$MODIFIED_FILES" | while read -r file; do
          if [[ "$file" == *"/tasks/"* ]]; then
            echo "4:$file"
          elif [[ "$file" == *"/bronze/"* ]]; then
            echo "1:$file"
          elif [[ "$file" == *"/silver/"* ]]; then
            echo "2:$file"
          elif [[ "$file" == *"/gold/"* ]]; then
            echo "3:$file"
          else
            echo "0:$file"
          fi
        done | sort -t: -k1,1n | cut -d: -f2-
      )

      for file in $ORDERED_FILES; do
        echo "Running $file on schema ${TARGET_SCHEMA}"

        OUTPUT=$(
          snowsql -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
            -d "$SNOWSQL_DB" -s "$TARGET_SCHEMA" \
            -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
            -o exit_on_error=true \
            -f "$file"
        )

        echo "$OUTPUT"

        if [[ "$file" == sql/procedures/* ]]; then
          PROC_NAME=$(echo "$OUTPUT" | grep -oP 'Function \K[^ ]+' | head -1 || true)
          if [[ -n "${PROC_NAME:-}" ]]; then
            echo "Calling procedure $PROC_NAME on schema ${TARGET_SCHEMA}"
            snowsql -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -d "$SNOWSQL_DB" -s "$TARGET_SCHEMA" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o exit_on_error=true \
              -q "CALL $PROC_NAME();"
          else
            echo "Could not extract the procedure name from the SnowSQL output for file $file"
            exit 1
          fi
        fi
      done

jobs:
  dev:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    env:
      TARGET_SCHEMA: DEV
    steps:
      - *common_setup
      - *run_changed_sql

  qa:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    needs: dev
    env:
      TARGET_SCHEMA: QA
    steps:
      - *common_setup
      - *run_changed_sql

  prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    env:
      TARGET_SCHEMA: ${{ env.SCHEMA_PRD }}
    steps:
      - *common_setup
      - *run_changed_sql
