# .github/workflows/snowflake_cicd.yml
name: Deploy Snowflake View

env:
  SCHEMA_PRD: PRD

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  dev:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien

      - name: Download and install SnowSQL via RPM
        run: |
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm

      - name: Add SnowSQL to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH

      - name: Check SnowSQL installation
        run: which snowsql && snowsql -v

      - name: Run SQL (DEV) in ordered phases
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        shell: bash
        run: |
          set -euo pipefail

          run_snowsql () {
            local schema="$1"; local file="$2"
            echo "::group::Running ${file} on schema ${schema}"
            snowsql \
              -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -d "$SNOWSQL_DB" -s "$schema" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o variable_substitution=true \
              -o exit_on_error=true \
              -o log_level=INFO \
              -f "$file" \
              --variable "SNOWSQL_AWS_KEY_ID=$SNOWSQL_AWS_KEY_ID" \
              --variable "SNOWSQL_AWS_SECRET_KEY=$SNOWSQL_AWS_SECRET_KEY"
            echo "::endgroup::"
          }

          list_phase () { # echo sorted list if exists
            ls -1 "$@" 2>/dev/null | sort || true
          }

          # ---------- Phase 1: migrations/database ----------
          PHASE1=$(list_phase migrations/database/*.sql)
          echo "Phase1 (migrations/database) count: $(echo "$PHASE1" | wc -w || echo 0)"
          for f in $PHASE1; do run_snowsql "DEV" "$f"; done

          # ---------- Phase 2: migrations/snowflake ----------
          PHASE2=$(list_phase migrations/snowflake/*.sql)
          echo "Phase2 (migrations/snowflake) count: $(echo "$PHASE2" | wc -w || echo 0)"
          for f in $PHASE2; do run_snowsql "DEV" "$f"; done

          # ---------- Phase 3: Medallion (bronze -> silver -> gold; tasks por último) ----------
          # usa 'find' para não depender de globs; ordena por camada/tipo/nome
          build_medallion_list () {
            find layers -type f -name "*.sql" | awk '
              function layer_rank(p){
                if (p ~ /\/bronze\//) return 1;
                if (p ~ /\/silver\//) return 2;
                if (p ~ /\/gold\//)   return 3;
                return 9;
              }
              function type_rank(p){
                if (p ~ /\/tasks\//)       return 5;  # por último sempre
                if (p ~ /\/ddl\//)         return 1;
                if (p ~ /\/views\//)       return 2;
                if (p ~ /\/procedures\//)  return 3;
                return 4;                   # outros antes de tasks
              }
              { printf("%d:%d:%s\n", layer_rank($0), type_rank($0), $0) }
            ' | sort -t: -k1,1n -k2,2n -k3,3 | cut -d: -f3- || true
          }

          PHASE3=$(build_medallion_list)
          echo "Phase3 (medallion) count: $(echo "$PHASE3" | wc -w || echo 0)"
          if [ -n "$PHASE3" ]; then
            while IFS= read -r f; do
              [ -z "$f" ] && continue
              run_snowsql "DEV" "$f"
            done <<< "$PHASE3"
          fi

  qa:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    needs: dev
    steps:
      - uses: actions/checkout@v3
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien
      - name: Download and install SnowSQL via RPM
        run: |
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm
      - name: Add SnowSQL to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH
      - name: Check SnowSQL installation
        run: which snowsql && snowsql -v
      - name: Run SQL (QA) in ordered phases
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        shell: bash
        run: |
          set -euo pipefail

          run_snowsql () {
            local schema="$1"; local file="$2"
            echo "::group::Running ${file} on schema ${schema}"
            snowsql -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" -d "$SNOWSQL_DB" -s "$schema" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o variable_substitution=true -o exit_on_error=true -o log_level=INFO \
              -f "$file" \
              --variable "SNOWSQL_AWS_KEY_ID=$SNOWSQL_AWS_KEY_ID" \
              --variable "SNOWSQL_AWS_SECRET_KEY=$SNOWSQL_AWS_SECRET_KEY"
            echo "::endgroup::"
          }

          list_phase () { ls -1 "$@" 2>/dev/null | sort || true; }
          build_medallion_list () {
            find layers -type f -name "*.sql" | awk '
              function layer_rank(p){ if(p~/\/bronze\//)return1; if(p~/\/silver\//)return2; if(p~/\/gold\//)return3; return9 }
              function type_rank(p){ if(p~/\/tasks\//)return5; if(p~/\/ddl\//)return1; if(p~/\/views\//)return2; if(p~/\/procedures\//)return3; return4 }
              { printf("%d:%d:%s\n", layer_rank($0), type_rank($0), $0) }
            ' | sort -t: -k1,1n -k2,2n -k3,3 | cut -d: -f3- || true
          }

          for f in $(list_phase migrations/database/*.sql);  do run_snowsql "QA" "$f"; done
          for f in $(list_phase migrations/snowflake/*.sql); do run_snowsql "QA" "$f"; done
          PHASE3=$(build_medallion_list)
          echo "Phase3 (medallion) count: $(echo "$PHASE3" | wc -w || echo 0)"
          if [ -n "$PHASE3" ]; then while IFS= read -r f; do [ -z "$f" ] || run_snowsql "QA" "$f"; done <<< "$PHASE3"; fi

  prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien
      - name: Download and install SnowSQL via RPM
        run: |
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm
      - name: Add SnowSQL to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH
      - name: Check SnowSQL installation
        run: which snowsql && snowsql -v
      - name: Run SQL (PROD) in ordered phases
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        shell: bash
        run: |
          set -euo pipefail

          run_snowsql () {
            local schema="$1"; local file="$2"
            echo "::group::Running ${file} on schema ${schema}"
            snowsql -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" -d "$SNOWSQL_DB" -s "$schema" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o variable_substitution=true -o exit_on_error=true -o log_level=INFO \
              -f "$file" \
              --variable "SNOWSQL_AWS_KEY_ID=$SNOWSQL_AWS_KEY_ID" \
              --variable "SNOWSQL_AWS_SECRET_KEY=$SNOWSQL_AWS_SECRET_KEY"
            echo "::endgroup::"
          }

          list_phase () { ls -1 "$@" 2>/dev/null | sort || true; }
          build_medallion_list () {
            find layers -type f -name "*.sql" | awk '
              function layer_rank(p){ if(p~/\/bronze\//)return1; if(p~/\/silver\//)return2; if(p~/\/gold\//)return3; return9 }
              function type_rank(p){ if(p~/\/tasks\//)return5; if(p~/\/ddl\//)return1; if(p~/\/views\//)return2; if(p~/\/procedures\//)return3; return4 }
              { printf("%d:%d:%s\n", layer_rank($0), type_rank($0), $0) }
            ' | sort -t: -k1,1n -k2,2n -k3,3 | cut -d: -f3- || true
          }

          for f in $(list_phase migrations/database/*.sql);  do run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done
          for f in $(list_phase migrations/snowflake/*.sql); do run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done
          PHASE3=$(build_medallion_list)
          echo "Phase3 (medallion) count: $(echo "$PHASE3" | wc -w || echo 0)"
          if [ -n "$PHASE3" ]; then while IFS= read -r f; do [ -z "$f" ] || run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done <<< "$PHASE3"; fi
