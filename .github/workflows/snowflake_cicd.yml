# .github/workflows/snowflake_cicd.yml
name: Deploy Snowflake View

env:
  SCHEMA_PRD: PRD

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  dev:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien

      - name: Download and install SnowSQL via RPM
        run: |
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm

      - name: Add SnowSQL to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH

      - name: Check SnowSQL installation
        run: which snowsql && snowsql -v

      - name: Run SQL (DEV) in ordered phases
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        run: |
          set -euo pipefail

          # List changed .sql files
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.sql$' || true)
          else
            MODIFIED_FILES=$(git show --pretty="" --name-only HEAD | grep '\.sql$' || true)
          fi

          if [ -z "${MODIFIED_FILES}" ]; then
            echo "No .sql files changed."
            exit 0
          fi

          # Phase 1: migrations/database/*.sql
          PHASE1=$(echo "$MODIFIED_FILES" | grep -E '^migrations/database/.*\.sql$' | sort || true)

          # Phase 2: migrations/snowflake/*.sql
          PHASE2=$(echo "$MODIFIED_FILES" | grep -E '^migrations/snowflake/.*\.sql$' | sort || true)

          # Phase 3: Medallion layers ordered: bronze -> silver -> gold, tasks last
          MEDALLION=$(echo "$MODIFIED_FILES" | grep -E '^layers/(bronze|silver|gold)/.*\.sql$' || true)
          PHASE3=$(echo "$MEDALLION" | while read -r file; do
            [ -z "$file" ] && continue
            if   [[ "$file" == *"/tasks/"* ]];     then echo "4:$file"
            elif [[ "$file" == layers/bronze/* ]]; then echo "1:$file"
            elif [[ "$file" == layers/silver/* ]]; then echo "2:$file"
            elif [[ "$file" == layers/gold/* ]];   then echo "3:$file"
            else echo "0:$file"; fi
          done | sort -t: -k1,1n -k2 | cut -d: -f2-)

          run_snowsql () {
            local schema="$1"; local file="$2"
            echo "Running ${file} on schema ${schema}"
            snowsql \
              -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -d "$SNOWSQL_DB" -s "$schema" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o variable_substitution=true \
              -o exit_on_error=true \
              -o log_level=INFO \
              -f "$file" \
              --variable "SNOWSQL_AWS_KEY_ID=$SNOWSQL_AWS_KEY_ID" \
              --variable "SNOWSQL_AWS_SECRET_KEY=$SNOWSQL_AWS_SECRET_KEY"
          }

          # Execute phases; any failure stops the job immediately.
          for f in $PHASE1; do run_snowsql "DEV" "$f"; done
          for f in $PHASE2; do run_snowsql "DEV" "$f"; done
          for f in $PHASE3; do run_snowsql "DEV" "$f"; done

  qa:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04
    needs: dev
    steps:
      - uses: actions/checkout@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien

      - name: Download and install SnowSQL via RPM
        run: |
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm

      - name: Add SnowSQL to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH

      - name: Check SnowSQL installation
        run: which snowsql && snowsql -v

      - name: Run SQL (QA) in ordered phases
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        run: |
          set -euo pipefail

          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.sql$' || true)
          else
            MODIFIED_FILES=$(git show --pretty="" --name-only HEAD | grep '\.sql$' || true)
          fi
          if [ -z "${MODIFIED_FILES}" ]; then
            echo "No .sql files changed."
            exit 0
          fi

          PHASE1=$(echo "$MODIFIED_FILES" | grep -E '^migrations/database/.*\.sql$' | sort || true)
          PHASE2=$(echo "$MODIFIED_FILES" | grep -E '^migrations/snowflake/.*\.sql$' | sort || true)
          MEDALLION=$(echo "$MODIFIED_FILES" | grep -E '^layers/(bronze|silver|gold)/.*\.sql$' || true)
          PHASE3=$(echo "$MEDALLION" | while read -r file; do
            [ -z "$file" ] && continue
            if   [[ "$file" == *"/tasks/"* ]];     then echo "4:$file"
            elif [[ "$file" == layers/bronze/* ]]; then echo "1:$file"
            elif [[ "$file" == layers/silver/* ]]; then echo "2:$file"
            elif [[ "$file" == layers/gold/* ]];   then echo "3:$file"
            else echo "0:$file"; fi
          done | sort -t: -k1,1n -k2 | cut -d: -f2-)

          run_snowsql () {
            local schema="$1"; local file="$2"
            echo "Running ${file} on schema ${schema}"
            snowsql \
              -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -d "$SNOWSQL_DB" -s "$schema" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o variable_substitution=true \
              -o exit_on_error=true \
              -o log_level=INFO \
              -f "$file" \
              --variable "SNOWSQL_AWS_KEY_ID=$SNOWSQL_AWS_KEY_ID" \
              --variable "SNOWSQL_AWS_SECRET_KEY=$SNOWSQL_AWS_SECRET_KEY"
          }

          for f in $PHASE1; do run_snowsql "QA" "$f"; done
          for f in $PHASE2; do run_snowsql "QA" "$f"; done
          for f in $PHASE3; do run_snowsql "QA" "$f"; done

  prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien

      - name: Download and install SnowSQL via RPM
        run: |
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm

      - name: Add SnowSQL to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH

      - name: Check SnowSQL installation
        run: which snowsql && snowsql -v

      - name: Run SQL (PROD) in ordered phases
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        run: |
          set -euo pipefail

          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.sql$' || true)
          else
            MODIFIED_FILES=$(git show --pretty="" --name-only HEAD | grep '\.sql$' || true)
          fi
          if [ -z "${MODIFIED_FILES}" ]; then
            echo "No .sql files changed."
            exit 0
          fi

          PHASE1=$(echo "$MODIFIED_FILES" | grep -E '^migrations/database/.*\.sql$' | sort || true)
          PHASE2=$(echo "$MODIFIED_FILES" | grep -E '^migrations/snowflake/.*\.sql$' | sort || true)
          MEDALLION=$(echo "$MODIFIED_FILES" | grep -E '^layers/(bronze|silver|gold)/.*\.sql$' || true)
          PHASE3=$(echo "$MEDALLION" | while read -r file; do
            [ -z "$file" ] && continue
            if   [[ "$file" == *"/tasks/"* ]];     then echo "4:$file"
            elif [[ "$file" == layers/bronze/* ]]; then echo "1:$file"
            elif [[ "$file" == layers/silver/* ]]; then echo "2:$file"
            elif [[ "$file" == layers/gold/* ]];   then echo "3:$file"
            else echo "0:$file"; fi
          done | sort -t: -k1,1n -k2 | cut -d: -f2-)

          run_snowsql () {
            local schema="$1"; local file="$2"
            echo "Running ${file} on schema ${schema}"
            snowsql \
              -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -d "$SNOWSQL_DB" -s "$schema" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o variable_substitution=true \
              -o exit_on_error=true \
              -o log_level=INFO \
              -f "$file" \
              --variable "SNOWSQL_AWS_KEY_ID=$SNOWSQL_AWS_KEY_ID" \
              --variable "SNOWSQL_AWS_SECRET_KEY=$SNOWSQL_AWS_SECRET_KEY"
          }

          for f in $PHASE1; do run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done
          for f in $PHASE2; do run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done
          for f in $PHASE3; do run_snowsql "${{ env.SCHEMA_PRD }}" "$f"; done
