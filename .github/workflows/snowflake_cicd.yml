name: Snowflake SQL CICD

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

env:
  SCHEMA_PRD: PRD

jobs:
  dev:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien wget

      - name: Install SnowSQL
        run: |
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm

      - name: Run SQL on DEV
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        run: |
          set -euo pipefail

          ENV_SCHEMA="DEV"
          MIGRATIONS_SCHEMA="PUBLIC"

          MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.sql$' || true)

          [ -z "$MODIFIED_FILES" ] && exit 0

          run_file() {
            snowsql \
              -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o exit_on_error=true \
              -o variable_substitution=true \
              --variable SNOWSQL_AWS_KEY_ID="$SNOWSQL_AWS_KEY_ID" \
              --variable SNOWSQL_AWS_SECRET_KEY="$SNOWSQL_AWS_SECRET_KEY" \
              -q "USE DATABASE \"$SNOWSQL_DB\"; USE SCHEMA \"$2\"; !source $1;"
          }

          for f in $MODIFIED_FILES; do
            [[ "$f" == layers/migrations/* ]] && run_file "$f" "$MIGRATIONS_SCHEMA" || run_file "$f" "$ENV_SCHEMA"
          done

  qa:
    if: github.ref != 'refs/heads/main'
    needs: dev
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3

      - name: Install SnowSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien wget
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm

      - name: Run SQL on QA
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
        run: |
          set -euo pipefail

          ENV_SCHEMA="QA"
          MIGRATIONS_SCHEMA="PUBLIC"

          MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.sql$' || true)

          [ -z "$MODIFIED_FILES" ] && exit 0

          run_file() {
            snowsql \
              -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o exit_on_error=true \
              -o variable_substitution=true \
              --variable SNOWSQL_AWS_KEY_ID="$SNOWSQL_AWS_KEY_ID" \
              --variable SNOWSQL_AWS_SECRET_KEY="$SNOWSQL_AWS_SECRET_KEY" \
              -q "USE DATABASE \"$SNOWSQL_DB\"; USE SCHEMA \"$2\"; !source $1;"
          }

          for f in $MODIFIED_FILES; do
            [[ "$f" == layers/migrations/* ]] && run_file "$f" "$MIGRATIONS_SCHEMA" || run_file "$f" "$ENV_SCHEMA"
          done

  prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3

      - name: Install SnowSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 libncurses6 alien wget
          wget https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.4/linux_x86_64/snowflake-snowsql-1.4.1-1.x86_64.rpm
          sudo alien -i snowflake-snowsql-1.4.1-1.x86_64.rpm

      - name: Run SQL on PRD
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWSQL_ACCOUNT }}
          SNOWSQL_DB: ${{ secrets.SNOWSQL_DB }}
          SNOWSQL_USER: ${{ secrets.SNOWSQL_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWSQL_PWD }}
          SNOWSQL_AWS_KEY_ID: ${{ secrets.SNOWSQL_AWS_KEY_ID }}
          SNOWSQL_AWS_SECRET_KEY: ${{ secrets.SNOWSQL_AWS_SECRET_KEY }}
          SCHEMA_PRD: ${{ env.SCHEMA_PRD }}
        run: |
          set -euo pipefail

          ENV_SCHEMA="$SCHEMA_PRD"
          MIGRATIONS_SCHEMA="PUBLIC"

          MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.sql$' || true)

          [ -z "$MODIFIED_FILES" ] && exit 0

          run_file() {
            snowsql \
              -a "$SNOWSQL_ACCOUNT" -u "$SNOWSQL_USER" \
              -h "$SNOWSQL_ACCOUNT.snowflakecomputing.com" -p 443 \
              -o exit_on_error=true \
              -o variable_substitution=true \
              --variable SNOWSQL_AWS_KEY_ID="$SNOWSQL_AWS_KEY_ID" \
              --variable SNOWSQL_AWS_SECRET_KEY="$SNOWSQL_AWS_SECRET_KEY" \
              -q "USE DATABASE \"$SNOWSQL_DB\"; USE SCHEMA \"$2\"; !source $1;"
          }

          for f in $MODIFIED_FILES; do
            [[ "$f" == layers/migrations/* ]] && run_file "$f" "$MIGRATIONS_SCHEMA" || run_file "$f" "$ENV_SCHEMA"
          done
